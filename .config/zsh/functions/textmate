#!/usr/bin/env zsh

# textmate - Manage TextMate bundles (converted from ðŸ“_textmate)
function textmate() {
    echo "ðŸ“ TextMate - https://github.com/textmate/textmate"
    echo
    local bundles=(blackpearl dashmate editorconfig fish gradle kotlin tomorrow-theme ublime)
    local bundle_dev="$HOME/dev/textmate"
    local bundle_dir="$HOME/Library/Application Support/TextMate/Bundles"

    mkdir -p "$bundle_dev" "$bundle_dir"
    pushd "$bundle_dev" || return

    for bundle in "${bundles[@]}"; do
        if [[ ! -e "$bundle.tmbundle" ]]; then
            case "$bundle" in
            blackpearl)
                clone_or_pull "$bundle.tmbundle/Themes" "git@github.com:ajwitte/textmate-goodies.git"
                tmbundleplist \
                    "Black Pearl Theme" \
                    "Colorful and Black & White color schemes. Plist generated by tmbundleplist function." \
                    "git@github.com:ajwitte/textmate-goodies.git" \
                    > "$bundle.tmbundle/Info.plist"
                ;;
            dashmate)
                clone_or_pull "DashMate.tmbundle" "git@github.com:ram-nadella/DashMate.tmbundle.git"
                ;;
            editorconfig)
                clone_or_pull "$bundle" "git@github.com:Mr0grog/editorconfig-textmate.git"
                local ec_version=0.3.1
                curl -L -O -# "https://github.com/Mr0grog/editorconfig-textmate/releases/download/v$ec_version/editorconfig-textmate-$ec_version.tmplugin.zip"
                local newest_file
                newest_file=$(find . -maxdepth 1 -type f -name '*.zip' -print0 | xargs -0 ls -t | head -n 1)
                unzip -o "$newest_file"
                rm -f "$newest_file"
                [[ $(status is-login) ]] && open "editorconfig-textmate.tmplugin"
                touch "$bundle.tmbundle"
                ;;
            fish)
                clone_or_pull "$bundle.tmbundle" "git@github.com:l15n/fish-tmbundle.git"
                ;;
            gradle)
                clone_or_pull "$bundle.tmbundle" "git@github.com:alkemist/gradle.tmbundle.git"
                ;;
            kotlin)
                clone_or_pull "$bundle" "git@github.com:sargunster/kotlin-textmate-bundle.git"
                local bundle="$bundle/Kotlin"
                ;;
            tomorrow-theme)
                clone_or_pull "$bundle" "git@github.com:chriskempson/tomorrow-theme.git"
                local bundle="tomorrow-theme/textmate2/Tomorrow Theme"
                ;;
            ublime)
                clone_or_pull "$bundle.tmbundle/Themes" "git@github.com:imagentleman/ublime.git"
                tmbundleplist \
                    "Ublime Color Schemes" \
                    "Colorful and Black & White color schemes. Plist generated by tmbundleplist function." \
                    "git@github.com:imagentleman/ublime.git" \
                    > "$bundle.tmbundle/Info.plist"
                ;;
            esac
        fi
        [[ $(filesize "$bundle.tmbundle") -gt 0 && $(status is-login) ]] && open "$bundle.tmbundle"
    done
    echo "$bundle_dev"
    ls
    popd || return
}
