# PAI Security Patterns
# Single source of truth for all security validation
# Used by SecurityValidator.hook.ts
#
# LOGGING: All blocked, confirmed, and alerted operations are logged to:
#   MEMORY/SECURITY/YYYY/MM/security-{event-summary}-{timestamp}.jsonl
# Review these logs periodically to tune patterns and detect anomalies.
#
# AI INTEGRATION: See RULE P3 in USER/AISTEERINGRULES.md
# The AI must use AskUserQuestion for confirm-category operations BEFORE
# attempting them. The hook serves as a backup safety net.
---
version: "1.1"
last_updated: "2026-02-14"

# Philosophy: Safe but functional by default
# Block catastrophic operations, confirm dangerous ones, allow everything else
# LAYERED DEFENSE:
#   1. AI uses AskUserQuestion for dangerous operations (proactive, contextual)
#   2. Hook validates and prompts if AI misses something (backup, generic)
#   3. All security events logged for retroactive review
philosophy:
  mode: safe_functional
  principle: "Meaningful protection without friction that drives people to disable security"

# ========================================
# BASH COMMAND PATTERNS
# ========================================
bash:
  # BLOCKED - Catastrophic/irreversible (exit 2, LOGGED)
  # These operations are NEVER allowed - hard block with exit code 2
  # NOTE: Patterns use regex. Only block TOP-LEVEL directory destruction.
  # Nested deletions (e.g., rm -rf ~/Projects/foo) are ALLOWED for normal operations.
  blocked:
    # Filesystem root - absolute block
    - pattern: "rm -rf /$"
      reason: "Filesystem destruction"
      regex: true
    - pattern: "rm -rf / "
      reason: "Filesystem destruction"

    # Home directory - only block entire home, not subdirs
    - pattern: "rm -rf ~$"
      reason: "Home directory destruction (entire home)"
      regex: true
    - pattern: "rm -rf ~ "
      reason: "Home directory destruction (entire home)"
    - pattern: "rm -rf ~/$"
      reason: "Home directory destruction (entire home)"
      regex: true
    - pattern: "rm -rf ~/ "
      reason: "Home directory destruction (entire home)"

    # PAI infrastructure - only block entire .claude, not subdirs
    - pattern: "rm -rf ~/.claude$"
      reason: "PAI infrastructure destruction (entire .claude)"
      regex: true
    - pattern: "rm -rf ~/.claude "
      reason: "PAI infrastructure destruction (entire .claude)"
    - pattern: "rm -rf ~/.claude/$"
      reason: "PAI infrastructure destruction (entire .claude)"
      regex: true
    - pattern: "rm -rf ~/.claude/ "
      reason: "PAI infrastructure destruction (entire .claude)"

    # Projects directory - only block entire Projects, not subdirs
    - pattern: "rm -rf ~/Projects$"
      reason: "Projects directory destruction (entire Projects)"
      regex: true
    - pattern: "rm -rf ~/Projects "
      reason: "Projects directory destruction (entire Projects)"
    - pattern: "rm -rf ~/Projects/$"
      reason: "Projects directory destruction (entire Projects)"
      regex: true
    - pattern: "rm -rf ~/Projects/ "
      reason: "Projects directory destruction (entire Projects)"

    # Sudo variants
    - pattern: "sudo rm -rf /$"
      reason: "Filesystem destruction with sudo"
      regex: true
    - pattern: "sudo rm -rf / "
      reason: "Filesystem destruction with sudo"
    - pattern: "sudo rm -rf ~$"
      reason: "Home directory destruction with sudo"
      regex: true
    - pattern: "sudo rm -rf ~ "
      reason: "Home directory destruction with sudo"
    - pattern: "diskutil eraseDisk"
      reason: "Disk destruction"
    - pattern: "diskutil zeroDisk"
      reason: "Disk destruction"
    - pattern: "diskutil partitionDisk"
      reason: "Disk partitioning"
    - pattern: "diskutil apfs deleteContainer"
      reason: "APFS container deletion"
    - pattern: "diskutil apfs eraseVolume"
      reason: "Volume destruction"
    - pattern: "dd if=/dev/zero"
      reason: "Disk overwrite"
    - pattern: "mkfs"
      reason: "Filesystem format"
    - pattern: "gh repo delete"
      reason: "Repository deletion"
    - pattern: "gh repo edit --visibility public"
      reason: "Repository exposure"

  # CONFIRM - Dangerous but sometimes legitimate (LOGGED + prompt)
  # AI should use AskUserQuestion before attempting (see RULE P3)
  confirm:
    # Git operations
    - pattern: "git push --force"
      reason: "Force push can lose commits"
    - pattern: "git push -f"
      reason: "Force push can lose commits"
    - pattern: "git push origin --force"
      reason: "Force push can lose commits"
    - pattern: "git push origin -f"
      reason: "Force push can lose commits"
    - pattern: "git reset --hard"
      reason: "Loses uncommitted changes"

    # Cloud - AWS
    - pattern: "aws s3 rm.*--recursive"
      reason: "Bulk S3 deletion"
    - pattern: "aws ec2 terminate"
      reason: "EC2 instance termination"
    - pattern: "aws rds delete"
      reason: "RDS deletion"

    # Cloud - GCP
    - pattern: "gcloud.*delete"
      reason: "GCP resource deletion"

    # Infrastructure as Code
    - pattern: "terraform destroy"
      reason: "Infrastructure destruction"
    - pattern: "terraform apply.*-auto-approve"
      reason: "Auto-approve bypasses review"
    - pattern: "pulumi destroy"
      reason: "Infrastructure destruction"

    # Containers
    - pattern: "docker system prune"
      reason: "Container/image cleanup"
    - pattern: "docker volume rm"
      reason: "Volume data deletion"
    - pattern: "kubectl delete namespace"
      reason: "Namespace deletion"

    # Databases
    - pattern: "DELETE FROM.*WHERE"
      reason: "Database deletion (confirm scope)"
    - pattern: "DROP DATABASE"
      reason: "Database destruction"
    - pattern: "DROP TABLE"
      reason: "Table destruction"
    - pattern: "TRUNCATE"
      reason: "Table data destruction"

  # ALERT - Suspicious but allowed (LOGGED, no block)
  alert:
    - pattern: "curl.*\\|.*sh"
      reason: "Piping curl to shell"
    - pattern: "curl.*\\|.*bash"
      reason: "Piping curl to bash"
    - pattern: "wget.*\\|.*sh"
      reason: "Piping wget to shell"
    - pattern: "wget.*\\|.*bash"
      reason: "Piping wget to bash"

# ========================================
# PATH PROTECTION (all violations LOGGED)
# ========================================
paths:
  # ZERO ACCESS - Complete denial for all operations (read/write/delete)
  zeroAccess:
    - "~/.ssh/id_*"
    - "~/.ssh/*.pem"
    - "~/.aws/credentials"
    - "~/.gnupg/private*"
    - "**/credentials.json"
    - "**/service-account*.json"

  # READ ONLY - Can read but cannot modify or delete
  readOnly:
    - "/etc/**"

  # CONFIRM WRITE - Can read freely, writing requires confirmation
  confirmWrite:
    - "~/.claude/settings.json"
    - "**/.env"
    - "**/.env.*"
    - "~/.ssh/*"

  # NO DELETE - Can read and modify but cannot delete
  noDelete:
    - "~/.claude/hooks/**"
    - "~/.claude/skills/PAI/**"
    - ".git/**"
    - "LICENSE*"
    - "README.md"

# ========================================
# SPECIAL PROJECT RULES (customize for your projects)
# ========================================
# Add project-specific rules here. Example:
#
# projects:
#   my-project:
#     path: "${PROJECTS_DIR}/my-project"
#     rules:
#       - action: "block_git_push"
#         reason: "Deploy via wrangler only, GitHub has README only"
#       - action: "allow_wrangler_deploy"
#         reason: "This is the correct deployment method"
